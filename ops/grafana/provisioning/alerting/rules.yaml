apiVersion: 1

groups:
  - orgId: 1
    name: printexpert-observability
    folder: Observability
    interval: 1m
    rules:
      - uid: pe_5xx_warning
        title: "5xx Spike Warning"
        condition: C
        noDataState: OK
        execErrState: Error
        for: 0m
        labels:
          severity: warning
          signal: "5xx"
        annotations:
          summary: "5xx spike warning"
        data:
          - refId: A
            datasourceUid: loki
            relativeTimeRange:
              from: 300
              to: 0
            model:
              datasource:
                type: loki
                uid: loki
              editorMode: code
              expr: sum(count_over_time({container="shop-web"} | json | event="http.request.completed" | status=~"5.." [5m]))
              instant: true
              intervalMs: 1000
              maxDataPoints: 43200
              queryType: instant
              refId: A
          - refId: C
            datasourceUid: __expr__
            relativeTimeRange:
              from: 0
              to: 0
            model:
              conditions:
                - evaluator:
                    params: [5]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold

      - uid: pe_5xx_critical
        title: "5xx Spike Critical"
        condition: C
        noDataState: OK
        execErrState: Error
        for: 0m
        labels:
          severity: critical
          signal: "5xx"
        annotations:
          summary: "5xx spike critical"
        data:
          - refId: A
            datasourceUid: loki
            relativeTimeRange:
              from: 300
              to: 0
            model:
              datasource:
                type: loki
                uid: loki
              editorMode: code
              expr: sum(count_over_time({container="shop-web"} | json | event="http.request.completed" | status=~"5.." [5m]))
              instant: true
              intervalMs: 1000
              maxDataPoints: 43200
              queryType: instant
              refId: A
          - refId: C
            datasourceUid: __expr__
            relativeTimeRange:
              from: 0
              to: 0
            model:
              conditions:
                - evaluator:
                    params: [15]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold

      - uid: pe_auth_failed_warning
        title: "Auth Failures Spike Warning"
        condition: C
        noDataState: OK
        execErrState: Error
        for: 0m
        labels:
          severity: warning
          signal: "auth_failed"
        annotations:
          summary: "auth.login_failed spike warning"
        data:
          - refId: A
            datasourceUid: loki
            relativeTimeRange:
              from: 600
              to: 0
            model:
              datasource:
                type: loki
                uid: loki
              editorMode: code
              expr: sum(count_over_time({container="shop-web"} | json | event="auth.login_failed" [10m]))
              instant: true
              intervalMs: 1000
              maxDataPoints: 43200
              queryType: instant
              refId: A
          - refId: C
            datasourceUid: __expr__
            relativeTimeRange:
              from: 0
              to: 0
            model:
              conditions:
                - evaluator:
                    params: [10]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold

      - uid: pe_auth_failed_critical
        title: "Auth Failures Spike Critical"
        condition: C
        noDataState: OK
        execErrState: Error
        for: 0m
        labels:
          severity: critical
          signal: "auth_failed"
        annotations:
          summary: "auth.login_failed spike critical"
        data:
          - refId: A
            datasourceUid: loki
            relativeTimeRange:
              from: 600
              to: 0
            model:
              datasource:
                type: loki
                uid: loki
              editorMode: code
              expr: sum(count_over_time({container="shop-web"} | json | event="auth.login_failed" [10m]))
              instant: true
              intervalMs: 1000
              maxDataPoints: 43200
              queryType: instant
              refId: A
          - refId: C
            datasourceUid: __expr__
            relativeTimeRange:
              from: 0
              to: 0
            model:
              conditions:
                - evaluator:
                    params: [25]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold

      - uid: pe_csrf_origin_warning
        title: "CSRF/Origin Violations Warning"
        condition: C
        noDataState: OK
        execErrState: Error
        for: 0m
        labels:
          severity: warning
          signal: "csrf_origin"
        annotations:
          summary: "security.csrf_blocked/origin_blocked spike warning"
        data:
          - refId: A
            datasourceUid: loki
            relativeTimeRange:
              from: 600
              to: 0
            model:
              datasource:
                type: loki
                uid: loki
              editorMode: code
              expr: sum(count_over_time({container="shop-web"} | json | event=~"security.csrf_blocked|security.origin_blocked" [10m]))
              instant: true
              intervalMs: 1000
              maxDataPoints: 43200
              queryType: instant
              refId: A
          - refId: C
            datasourceUid: __expr__
            relativeTimeRange:
              from: 0
              to: 0
            model:
              conditions:
                - evaluator:
                    params: [10]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold

      - uid: pe_csrf_origin_critical
        title: "CSRF/Origin Violations Critical"
        condition: C
        noDataState: OK
        execErrState: Error
        for: 0m
        labels:
          severity: critical
          signal: "csrf_origin"
        annotations:
          summary: "security.csrf_blocked/origin_blocked spike critical"
        data:
          - refId: A
            datasourceUid: loki
            relativeTimeRange:
              from: 600
              to: 0
            model:
              datasource:
                type: loki
                uid: loki
              editorMode: code
              expr: sum(count_over_time({container="shop-web"} | json | event=~"security.csrf_blocked|security.origin_blocked" [10m]))
              instant: true
              intervalMs: 1000
              maxDataPoints: 43200
              queryType: instant
              refId: A
          - refId: C
            datasourceUid: __expr__
            relativeTimeRange:
              from: 0
              to: 0
            model:
              conditions:
                - evaluator:
                    params: [30]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold

      - uid: pe_rate_limit_warning
        title: "Rate Limit Denied Spike Warning"
        condition: C
        noDataState: OK
        execErrState: Error
        for: 0m
        labels:
          severity: warning
          signal: "rate_limit"
        annotations:
          summary: "security.rate_limit_denied spike warning"
        data:
          - refId: A
            datasourceUid: loki
            relativeTimeRange:
              from: 600
              to: 0
            model:
              datasource:
                type: loki
                uid: loki
              editorMode: code
              expr: sum(count_over_time({container="shop-web"} | json | event="security.rate_limit_denied" [10m]))
              instant: true
              intervalMs: 1000
              maxDataPoints: 43200
              queryType: instant
              refId: A
          - refId: C
            datasourceUid: __expr__
            relativeTimeRange:
              from: 0
              to: 0
            model:
              conditions:
                - evaluator:
                    params: [20]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold

      - uid: pe_rate_limit_critical
        title: "Rate Limit Denied Spike Critical"
        condition: C
        noDataState: OK
        execErrState: Error
        for: 0m
        labels:
          severity: critical
          signal: "rate_limit"
        annotations:
          summary: "security.rate_limit_denied spike critical"
        data:
          - refId: A
            datasourceUid: loki
            relativeTimeRange:
              from: 600
              to: 0
            model:
              datasource:
                type: loki
                uid: loki
              editorMode: code
              expr: sum(count_over_time({container="shop-web"} | json | event="security.rate_limit_denied" [10m]))
              instant: true
              intervalMs: 1000
              maxDataPoints: 43200
              queryType: instant
              refId: A
          - refId: C
            datasourceUid: __expr__
            relativeTimeRange:
              from: 0
              to: 0
            model:
              conditions:
                - evaluator:
                    params: [50]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold

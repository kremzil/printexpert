// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  USER
  ADMIN
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  image         String?
  passwordHash  String?
  role          UserRole  @default(USER)
  stripeCustomerId String? @unique
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  accounts      Account[]
  sessions      Session[]
  authTokens    AuthToken[]
  carts         Cart[]
  orders        Order[]
  orderAssets   OrderAsset[]
  orderStatusHistory OrderStatusHistory[]
  addresses     UserAddress[]
  companyProfile CompanyProfile?
  savedCarts    SavedCart[]
}

model CompanyProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  companyName String
  ico         String?
  dic         String?
  icDph       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UserAddress {
  id          String   @id @default(cuid())
  userId      String
  label       String
  apt         String?
  street      String
  city        String
  zipCode     String
  country     String
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isDefault])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model AuthToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum PriceType {
  ON_REQUEST
  FIXED
  MATRIX
  AREA
}

enum PricingKind {
  BASE
  FINISHING
}

model Category {
  id          String     @id @default(uuid()) @db.Uuid
  slug        String     @unique
  name        String
  image       String
  description String?
  sortOrder   Int        @default(0)
  isActive    Boolean    @default(true)
  showInB2b   Boolean    @default(true)
  showInB2c   Boolean    @default(true)
  parentId    String?    @db.Uuid
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  products    Product[]
}

model Product {
  id          String         @id @default(uuid()) @db.Uuid
  slug        String         @unique
  name        String
  categoryId  String         @db.Uuid
  category    Category       @relation(fields: [categoryId], references: [id])
  wpProductId Int?
  excerpt     String?
  description String?
  priceType   PriceType      @default(ON_REQUEST)
  priceFrom   Decimal?       @db.Decimal(12, 2)
  priceAfterDiscountFrom Decimal? @db.Decimal(12, 2)
  vatRate     Decimal        @default(0.20) @db.Decimal(4, 2)
  isActive    Boolean        @default(true)
  showInB2b   Boolean        @default(true)
  showInB2c   Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  images      ProductImage[]
  pricingModels PricingModel[]
  cartItems   CartItem[]
  orderItems  OrderItem[]
  savedCartItems SavedCartItem[]

  // Design Studio
  designerEnabled      Boolean  @default(false)
  designerWidth        Int?     // canvas width in px
  designerHeight       Int?     // canvas height in px
  designerBgColor      String?  // background color hex
  designerDpi          Int?     @default(300)
  designerColorProfile String?  @default("CMYK")
  designTemplates      DesignTemplate[]

  @@index([categoryId])
}

model ProductImage {
  id        String  @id @default(uuid()) @db.Uuid
  productId String  @db.Uuid
  product   Product @relation(fields: [productId], references: [id])
  url       String
  alt       String?
  sortOrder Int     @default(0)
  isPrimary Boolean @default(false)

  @@index([productId])
  @@unique([productId, url])
}

model PricingModel {
  id            String        @id @default(uuid()) @db.Uuid
  productId     String        @db.Uuid
  product       Product       @relation(fields: [productId], references: [id])
  kind          PricingKind
  sourceMtypeId Int
  breakpoints   Json
  numStyle      Int?
  numType       Int?
  aUnit         String?
  meta          Json?
  isActive      Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  entries       PricingEntry[]

  @@index([productId])
  @@unique([productId, sourceMtypeId])
}

model PricingEntry {
  id             String       @id @default(uuid()) @db.Uuid
  pricingModelId String       @db.Uuid
  pricingModel   PricingModel @relation(fields: [pricingModelId], references: [id], onDelete: Cascade)
  attrsKey       String
  breakpoint     BigInt
  price          Decimal      @db.Decimal(12, 2)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([pricingModelId, attrsKey, breakpoint])
  @@index([pricingModelId, attrsKey])
  @@index([pricingModelId, breakpoint])
}

model WpMatrixType {
  mtypeId         Int     @id
  productId       Int
  mtype           Int
  isActive        Boolean @default(true)
  title           String?
  defQuantity     Int?
  attributes      String?
  aterms          String?
  numbers         String?
  numStyle        Int?
  numType         Int?
  aUnit           String?
  bqNumbers       String?
  ltextAttr       Int?
  bookMinQuantity Int?
  pqStyle         Int?
  pqNumbers       String?
  sorder          Int?
  minQMailed      Int?
}

model WpMatrixPrice {
  id       Int     @id @default(autoincrement())
  mtypeId  Int
  aterms   String
  number   BigInt
  price    Decimal @db.Decimal(18, 2)

  @@unique([mtypeId, aterms, number])
  @@index([mtypeId])
}

model WpTerm {
  termId    Int     @id
  name      String
  slug      String?
  termGroup Int?
}

model WpTermTaxonomy {
  termTaxonomyId Int     @id
  termId         Int
  taxonomy       String
  description    String?
  parent         Int?
  count          Int?

  @@index([termId])
  @@index([taxonomy])
}

model WpTermRelationship {
  id              Int @id @default(autoincrement())
  objectId        Int
  termTaxonomyId  Int
  termOrder       Int?

  @@unique([objectId, termTaxonomyId])
  @@index([objectId])
  @@index([termTaxonomyId])
}

model WpTermMeta {
  metaId    Int    @id
  termId    Int
  metaKey   String?
  metaValue String?

  @@index([termId])
  @@index([metaKey])
}

model WpAttributeTaxonomy {
  attributeId     Int     @id
  attributeName   String
  attributeLabel  String
  attributeType   String?
  attributeOrder  Int?
  attributePublic Int?
}

// ===== Cart & Checkout Models =====

model Cart {
  id        String     @id @default(cuid())
  userId    String?    @unique
  user      User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId String?    @unique
  items     CartItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([sessionId])
}

model CartItem {
  id              String   @id @default(cuid())
  cartId          String
  cart            Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId       String   @db.Uuid
  product         Product  @relation(fields: [productId], references: [id])
  quantity        Int
  width           Decimal? @db.Decimal(10, 2)
  height          Decimal? @db.Decimal(10, 2)
  selectedOptions Json?
  priceSnapshot   Json?
  designData      Json?    // elements from Design Studio
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([cartId])
  @@index([productId])
}

model SavedCart {
  id        String          @id @default(cuid())
  userId    String
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String?
  items     SavedCartItem[]
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@index([userId])
}

model SavedCartItem {
  id          String     @id @default(cuid())
  savedCartId String
  savedCart   SavedCart  @relation(fields: [savedCartId], references: [id], onDelete: Cascade)
  productId   String     @db.Uuid
  product     Product    @relation(fields: [productId], references: [id])
  quantity    Int
  width       Decimal?   @db.Decimal(10, 2)
  height      Decimal?   @db.Decimal(10, 2)
  selectedOptions Json?
  priceSnapshot   Json?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([savedCartId])
  @@index([productId])
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  UNPAID
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum PaymentProvider {
  STRIPE
}

enum OrderAssetKind {
  ARTWORK
  PREVIEW
  INVOICE
  OTHER
}

enum OrderAssetStatus {
  PENDING
  UPLOADED
  APPROVED
  REJECTED
}

enum OrderAssetStorageProvider {
  S3
}

model Order {
  id              String      @id @default(cuid())
  orderNumber     String      @unique
  userId          String?
  user            User?       @relation(fields: [userId], references: [id])
  audience        String      @default("b2c")
  status          OrderStatus @default(PENDING)
  paymentStatus   PaymentStatus @default(UNPAID)
  paymentProvider PaymentProvider?
  stripePaymentIntentId String? @unique
  stripeCheckoutSessionId String? @unique
  paidAt          DateTime?
  items           OrderItem[]
  assets          OrderAsset[]
  notificationLogs NotificationLog[]
  statusHistory   OrderStatusHistory[]
  stripeEvents    StripeEvent[]
  subtotal        Decimal     @db.Decimal(12, 2)
  vatAmount       Decimal     @db.Decimal(12, 2)
  total           Decimal     @db.Decimal(12, 2)
  customerName    String
  customerEmail   String
  customerPhone   String?
  shippingAddress Json?
  billingAddress  Json?
  notes           String?     @db.Text
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([userId])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
  @@index([audience])
  @@index([customerEmail])
  @@index([orderNumber])
}

model OrderStatusHistory {
  id              String      @id @default(cuid())
  orderId         String
  order           Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  fromStatus      OrderStatus
  toStatus        OrderStatus
  changedByUserId String?
  changedByUser   User?       @relation(fields: [changedByUserId], references: [id], onDelete: SetNull)
  note            String?     @db.Text
  createdAt       DateTime    @default(now())

  @@index([orderId, createdAt])
  @@index([changedByUserId])
}

model StripeEvent {
  id        String   @id
  type      String
  orderId   String?
  order     Order?   @relation(fields: [orderId], references: [id], onDelete: SetNull)
  payload   Json?
  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([type])
}

model OrderItem {
  id              String  @id @default(cuid())
  orderId         String
  order           Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId       String  @db.Uuid
  product         Product @relation(fields: [productId], references: [id])
  productName     String
  quantity        Int
  width           Decimal? @db.Decimal(10, 2)
  height          Decimal? @db.Decimal(10, 2)
  selectedOptions Json?
  priceNet        Decimal  @db.Decimal(12, 2)
  priceVat        Decimal  @db.Decimal(12, 2)
  priceGross      Decimal  @db.Decimal(12, 2)
  priceSnapshot   Json?
  designData      Json?    // elements from Design Studio
  assets          OrderAsset[]

  @@index([orderId])
  @@index([productId])
}

model OrderAsset {
  id               String                   @id @default(cuid())
  orderId          String
  order            Order                    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderItemId      String?
  orderItem        OrderItem?               @relation(fields: [orderItemId], references: [id], onDelete: SetNull)
  kind             OrderAssetKind
  status           OrderAssetStatus         @default(PENDING)
  fileNameOriginal String
  mimeType         String
  sizeBytes        Int
  checksum         String?
  storageProvider  OrderAssetStorageProvider @default(S3)
  bucket           String
  objectKey        String
  region           String?
  uploadedByUserId String?
  uploadedByUser   User?                    @relation(fields: [uploadedByUserId], references: [id], onDelete: SetNull)
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt

  @@index([orderId, createdAt])
  @@index([orderItemId])
  @@index([status])
}

enum NotificationType {
  ORDER_CREATED
  ORDER_STATUS_CHANGED
  ARTWORK_UPLOADED
}

enum NotificationStatus {
  SENT
  FAILED
}

model NotificationLog {
  id                String             @id @default(cuid())
  type              NotificationType
  orderId           String?
  order             Order?             @relation(fields: [orderId], references: [id], onDelete: SetNull)
  toEmail           String
  status            NotificationStatus
  error             String?
  providerMessageId String?
  createdAt         DateTime           @default(now())

  @@unique([type, orderId, toEmail])
  @@index([orderId])
  @@index([status])
}

enum TopProductsMode {
  RANDOM_ALL
  RANDOM_CATEGORIES
  MANUAL
}

model TopProducts {
  id           String          @id @default(cuid())
  audience     String          @unique // "b2b" or "b2c"
  mode         TopProductsMode @default(RANDOM_ALL)
  categoryIds  String[]        // for RANDOM_CATEGORIES mode
  productIds   String[]        // for MANUAL mode
  updatedAt    DateTime        @updatedAt
  createdAt    DateTime        @default(now())
}

model ProductCollection {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  image       String
  description String?
  productIds  String[]
  isActive    Boolean  @default(true)
  showInB2b   Boolean  @default(true)
  showInB2c   Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive, sortOrder])
}

model DesignTemplate {
  id          String   @id @default(uuid()) @db.Uuid
  productId   String   @db.Uuid
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  name        String
  elements    Json     // array of DesignElement objects
  thumbnailUrl String?
  isDefault   Boolean  @default(false)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([productId])
}

model ShopSettings {
  id        String   @id @default("default")
  vatRate   Decimal  @default(0.20) @db.Decimal(4, 2)
  pricesIncludeVat Boolean @default(true)
  pdfSettings Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RateLimitEntry {
  key       String   @id
  count     Int      @default(0)
  resetAt   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([resetAt])
}

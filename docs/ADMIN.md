# Админка PrintExpert — описание и текущее состояние

Ниже — краткое описание админской части, что уже реализовано и на что опираться при дальнейшей разработке.

## Общее

Админка реализована в App Router и работает на данных из PostgreSQL через Prisma. Основная цель — управлять товарами и матрицами цен, а также справочником свойств (атрибутов) и их значений.

Текущие страницы:
- `/admin` — список товаров.
- `/admin/products/[id]` — карточка товара + матрицы цен.
- `/admin/vlastnosti` — свойства (атрибуты) из WP-таблиц.
- `/admin/vlastnosti/[attributeId]` — значения конкретного свойства.

> Внимание: аутентификация/авторизация не добавлены.

## Источники данных

Используются таблицы WP-импорта (в Prisma):
- `WpMatrixType` — матрицы (типы).
- `WpMatrixPrice` — цены по комбинациям/брейкпоинтам.
- `WpAttributeTaxonomy` — свойства (атрибуты).
- `WpTerm`, `WpTermTaxonomy`, `WpTermRelationship`, `WpTermMeta` — значения атрибутов и их связи.

Плюс базовые таблицы каталога:
- `Product`, `Category`, `ProductImage`, `PricingModel`, `PricingEntry`.

## Страница /admin — список товаров

Что выводится:
- Название и slug товара.
- Категория.
- Статус активности.
- Ссылка на редактирование товара.

Данные: `lib/catalog.ts` → `getAdminProducts()` (берёт все товары без фильтра `isActive`).

## Страница /admin/products/[id] — товар + матрицы

### Карточка товара
- Поля товара отображаются, но **сохранение ещё не реализовано**.
- Поля: название, slug, краткое/полное описание, цена от, DPH.

### Матрицы цен
Матрицы берутся из WP-таблиц через `getWpCalculatorData`.

#### Привязка к WP
Используется словарь `wpProductIdBySlug` (по slug → WP productId).
Если WP ID не задан — матрицы не загрузятся.

#### Создание матрицы
Форма создания матрицы позволяет:
- Задать название, тип (базовая/докончавающая), тип количества (ntp) и breakpoints.
- Выбрать свойства и конкретные значения, которые войдут в матрицу.

При создании сохраняются:
- `WpMatrixType.attributes` — PHP-serialized список выбранных `attributeId`.
- `WpMatrixType.aterms` — PHP-serialized словарь `{ attributeId: [termId...] }`.

#### Генерация ценовых строк
Если у матрицы нет цен, появляется кнопка **«Vygenerovať ceny»**.
Она создаёт все комбинации выбранных значений × breakpoints и кладёт их в `WpMatrixPrice` с ценой `0`.

#### Редактирование цен
- Цены редактируются в таблице и сохраняются одной кнопкой «Uložiť maticu».
- Сохраняются только существующие строки `WpMatrixPrice`.

#### Удаление матрицы
- Есть подтверждение удаления.
- Удаляется сама матрица и все её цены.

## Страница /admin/vlastnosti — свойства (атрибуты)

Что есть:
- Список всех свойств (`WpAttributeTaxonomy`).
- Создание нового свойства.
- Удаление свойства с подтверждением.

Создание:
- `attributeName` = сгенерированный slug (если пусто — от названия).
- `attributeLabel` = название.

Удаление:
- Удаляет связанную таксономию `pa_<slug>`, все связи и значения,
  **но** удаляет термы только если они больше нигде не используются.

## Страница /admin/vlastnosti/[attributeId] — значения свойства

Что есть:
- Список значений (термы) по таксономии `pa_<attributeName>`.
- Создание нового значения.
- Удаление значения.

Создание:
- Добавляется запись в `WpTerm` и `WpTermTaxonomy`.

Удаление:
- Удаляется связь `WpTermRelationship` и запись `WpTermTaxonomy`.
- Если терм больше нигде не используется — удаляется из `WpTerm` и `WpTermMeta`.

## Важные ограничения и заметки

- Сохранение полей товара **не реализовано** — UI только для чтения.
- Новые строки `WpMatrixPrice` создаются только через «Vygenerovať ceny».
- `wpProductIdBySlug` в БД
- Для сериализации используется простая реализация PHP serialize/unserialize
  (должна совпадать с тем, как работает `lib/wp-calculator.ts`).

## Следующие логичные шаги

- Добавить редактирование и сохранение карточки товара.
- Добавить создание/редактирование комбинаций цен вручную (не только генерация).
- Добавить поиск/фильтры по свойствам и товарам.
- Добавить авторизацию.

# Админка PrintExpert — описание и текущее состояние

Ниже — краткое описание админской части, что уже реализовано и на что опираться при дальнейшей разработке.

## Общее

Админка реализована в App Router и работает на данных из PostgreSQL через Prisma. Основная цель — управлять товарами и матрицами цен, а также справочником свойств (атрибутов) и их значений.

Текущие страницы:
- `/admin` — список товаров.
- `/admin/products/[id]` — карточка товара + матрицы цен.
- `/admin/vlastnosti` — свойства (атрибуты) из WP-таблиц.
- `/admin/vlastnosti/[attributeId]` — значения конкретного свойства.

> Внимание: аутентификация/авторизация не добавлены.

## Источники данных

Используются таблицы WP-импорта (в Prisma):
- `WpMatrixType` — матрицы (типы).
- `WpMatrixPrice` — цены по комбинациям/брейкпоинтам.
- `WpAttributeTaxonomy` — свойства (атрибуты).
- `WpTerm`, `WpTermTaxonomy`, `WpTermRelationship`, `WpTermMeta` — значения атрибутов и их связи.

Плюс базовые таблицы каталога:
- `Product`, `Category`, `ProductImage`, `PricingModel`, `PricingEntry`.

## Страница /admin — список товаров

Что выводится:
- Название и slug товара.
- Категория.
- Статус активности.
- Ссылка на редактирование товара.
- Поиск и фильтры по товарам с синхронизацией в URL (`q`, `status`, `category`).

Данные: `lib/catalog.ts` → `getAdminProducts()` (берёт все товары без фильтра `isActive`).

## Страница /admin/products/[id] — товар + матрицы

### Карточка товара
- Поля товара можно редактировать и сохранять.
- Поля: название, slug, краткое/полное описание, цена от, DPH.
- Детальное описание редактируется через WYSIWYG редактор (Tiptap) и сохраняется как HTML.
- Краткое описание редактируется через тот же WYSIWYG редактор.
- Название и slug редактируются inline (без постоянных инпутов).

### Матрицы цен
Матрицы берутся из WP-таблиц через `getWpCalculatorData`.

#### Привязка к WP
WP ID задаётся в карточке товара.
Если WP ID не задан — матрицы не загрузятся.

#### Создание матрицы
Матрицы создаются через Dialog:
- Вкладки для нескольких свойств (можно добавлять новые табы).
- Выбор значений внутри каждого свойства.
- Тип (базовая/докончавающая), тип количества (ntp) и breakpoints.
- Название матрицы формируется автоматически как `название продукта – набор свойств`.

При создании сохраняются:
- `WpMatrixType.attributes` — PHP-serialized список выбранных `attributeId`.
- `WpMatrixType.aterms` — PHP-serialized словарь `{ attributeId: [termId...] }`.

#### Редактирование матрицы
- Редактирование открывается тем же Dialog, что и создание (с предзаполненными данными).
- Докончавающая матрица может иметь только одно свойство (UI не даёт добавить второе).

#### Генерация ценовых строк
Если у матрицы нет цен, появляется кнопка **«Vygenerovať ceny»**.
Она создаёт все комбинации выбранных значений × breakpoints и кладёт их в `WpMatrixPrice` с ценой `0`.

#### Видимость на странице товара
- Для каждой матрицы есть Switch **«Zobraziť na stránke»**.
- На странице товара скрывается только отображение матрицы, но в расчётах она участвует независимо от `WpMatrixType.isActive`.

#### Редактирование цен
- Цены редактируются в таблице и сохраняются одной кнопкой «Uložiť maticu».
- Сохраняются только существующие строки `WpMatrixPrice`.

#### Удаление матрицы
- Есть подтверждение удаления.
- Удаляется сама матрица и все её цены.

## Страница /admin/vlastnosti — свойства (атрибуты)

Что есть:
- Список всех свойств (`WpAttributeTaxonomy`).
- Создание нового свойства.
- Удаление свойства с подтверждением.

Создание:
- `attributeName` = сгенерированный slug (если пусто — от названия).
- `attributeLabel` = название.

Удаление:
- Удаляет связанную таксономию `pa_<slug>`, все связи и значения,
  **но** удаляет термы только если они больше нигде не используются.

## Страница /admin/vlastnosti/[attributeId] — значения свойства

Что есть:
- Список значений (термы) по таксономии `pa_<attributeName>`.
- Создание нового значения.
- Удаление значения.

Создание:
- Добавляется запись в `WpTerm` и `WpTermTaxonomy`.

Удаление:
- Удаляется связь `WpTermRelationship` и запись `WpTermTaxonomy`.
- Если терм больше нигде не используется — удаляется из `WpTerm` и `WpTermMeta`.

## Важные ограничения и заметки

- Новые строки `WpMatrixPrice` создаются только через «Vygenerovať ceny».
- Для сериализации используется простая реализация PHP serialize/unserialize
  (должна совпадать с тем, как работает `lib/wp-calculator.ts`).
- HTML для описания товара очищается на сервере, ссылки сохраняются только с `https://`.
- Медиафайлы для редактора сохраняются в `/public/uploads` через `/api/uploads`.

## Следующие логичные шаги

- Добавить создание/редактирование комбинаций цен вручную (не только генерация).
- Добавить авторизацию.

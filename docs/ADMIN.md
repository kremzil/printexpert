# Админка PrintExpert — описание и текущее состояние

Ниже — краткое описание админской части, что уже реализовано и на что опираться при дальнейшей разработке.

## Общее

Админка реализована в App Router и работает на данных из PostgreSQL через Prisma. Основная цель — управлять товарами и матрицами цен, а также справочником свойств (атрибутов) и их значений.

Текущие страницы:
- `/admin` — дашборд со статистикой.
- `/admin/products` — список товаров.
- `/admin/products/[id]` — карточка товара + матрицы цен.
- `/admin/orders` — список заказов.
- `/admin/orders/[orderId]` — детали заказа + счёт (faktúra).
- `/admin/kategorie` — настройки категорий.
- `/admin/vlastnosti` — свойства (атрибуты) из WP-таблиц.
- `/admin/vlastnosti/[attributeId]` — значения конкретного свойства.
- `/admin/top-products` — управление блоком «Top produkty» на главной странице.
- `/admin/settings` — общие настройки магазина (в т.ч. PDF/Faktúry).

В деталях заказа (`/admin/orders/[orderId]`) отображаются файлы заказа, кнопки для скачивания/отправки счёта и доступно скачивание через presigned GET.

> Доступ к админке защищен ролью ADMIN (NextAuth v5).

## Источники данных

Используются таблицы WP-импорта (в Prisma):
- `WpMatrixType` — матрицы (типы).
- `WpMatrixPrice` — цены по комбинациям/брейкпоинтам.
- `WpAttributeTaxonomy` — свойства (атрибуты).
- `WpTerm`, `WpTermTaxonomy`, `WpTermRelationship`, `WpTermMeta` — значения атрибутов и их связи.

Плюс базовые таблицы каталога:
- `Product`, `Category`, `ProductImage`, `PricingModel`, `PricingEntry`.

## S3 загрузки (Order assets)

Загрузка файлов к заказам выполняется через presigned S3 URL:
- `POST /api/uploads/presign` → выдаёт `uploadUrl`.
- Клиент загружает файл в S3 (PUT).
- `POST /api/uploads/confirm` → подтверждает загрузку через `HEAD`.
- Скачивание: `GET /api/assets/[assetId]/download` (302 redirect на presigned GET).

### Важное
- В бакете должен быть настроен CORS для методов `GET`, `PUT`, `HEAD`.
- Для локальной разработки добавьте origin `http://localhost:3000`.
- Для продакшна добавьте домен сайта (например `https://printexpert.sk`).

## Страница /admin — Дашборд

Главная страница админки (`app/admin/page.tsx`). Отображает сводную статистику:
- **Карточки метрик (KPI):**
  - Общий доход за текущий месяц (на основе оплаченных/завершенных заказов).
  - Количество новых заказов (+% к прошлому месяцу).
  - Количество товаров в каталоге.
  - Активные пользователи за месяц.
- **График выручки:** Bar Chart (Recharts), показывающий динамику дохода по месяцам текущего года.
- **Последние продажи:** Список последних транзакций с именами клиентов и суммами.

Данные для дашборда собираются через `Prisma` агрегации (`_sum`, `count`) в серверном компоненте.

## Страница /admin/products — Список товаров

Полнофункциональная таблица управления товарами (`components/admin/admin-products-list.tsx`).
Использует **TanStack Table**.

**Возможности:**
- **Колонки:**
  - Изображение (превью thumbnail).
  - Название.
  - Категория.
  - Цена от (с форматированием цены).
  - Видимость (Бейджи: Активен, B2B, B2C).
  - Статистика (Количество заказов товара).
  - Действия (Dropdown: Просмотр на сайте, Редактирование, Удаление).
- **Фильтрация:**
  - Поиск по названию.
  - Фильтр по категории (Dropdown с search).
  - Фильтр по статусу (Активен/Неактивен).
- **Сортировка** по колонкам.
- **Управление колонками** (скрытие/отображение через меню).

Данные: `lib/catalog.ts` → `getAdminProducts()` (включает картинки и счетчики продаж).

## Страница /admin/products/[id] — товар + матрицы

### Карточка товара
- Полноценное редактирование свойств продукта.
- **Основные поля:** Название, Slug, Категория (Выбор из списка), Изображение (Вставка URL с превью).
- **Цены:** Цена "от" (priceFrom), Ставка НДС (vatRate).
- **Видимость:** 
  - `isActive` — глобальная активность.
  - `showInB2b` — видимость для B2B клиентов.
  - `showInB2c` — видимость для розничных клиентов.
- **Контент:** Краткое и полное описание (WYSIWYG Tiptap).
- Название и slug редактируются inline.
- `ProductTitleEditor` рендерится внутри формы сохранения.

### Матрицы цен
Матрицы берутся из WP-таблиц через `getWpCalculatorData`.

#### Привязка к WP
WP ID задаётся в карточке товара.
Если WP ID не задан — матрицы не загрузятся.

#### Создание матрицы
Матрицы создаются через Dialog:
- Вкладки для нескольких свойств (можно добавлять новые табы).
- Выбор значений внутри каждого свойства.
- Тип (базовая/докончавающая), тип количества (ntp) и breakpoints.
- Название матрицы формируется автоматически как `название продукта – набор свойств`.

При создании сохраняются:
- `WpMatrixType.attributes` — PHP-serialized список выбранных `attributeId`.
- `WpMatrixType.aterms` — PHP-serialized словарь `{ attributeId: [termId...] }`.

#### Редактирование матрицы
- Редактирование открывается тем же Dialog, что и создание (с предзаполненными данными).
- Докончавающая матрица может иметь только одно свойство (UI не даёт добавить второе).

#### Генерация ценовых строк
Если у матрицы нет цен, появляется кнопка **«Vygenerovať ceny»**.
Она создаёт все комбинации выбранных значений × breakpoints и кладёт их в `WpMatrixPrice` с ценой `0`.

#### Видимость на странице товара
- Для каждой матрицы есть Switch **«Zobraziť na stránke»**.
- На странице товара скрывается только отображение матрицы, но в расчётах она участвует независимо от `WpMatrixType.isActive`.

#### Редактирование цен
- Цены редактируются в таблице и сохраняются одной кнопкой «Uložiť maticu».
- Сохраняются только существующие строки `WpMatrixPrice`.

#### Удаление матрицы
- Есть подтверждение удаления.
- Удаляется сама матрица и все её цены.

## Страница /admin/vlastnosti — свойства (атрибуты)

Что есть:
- Список всех свойств (`WpAttributeTaxonomy`).
- Создание нового свойства.
- Удаление свойства с подтверждением.

Создание:
- `attributeName` = сгенерированный slug (если пусто — от названия).
- `attributeLabel` = название.

Удаление:
- Удаляет связанную таксономию `pa_<slug>`, все связи и значения,
  **но** удаляет термы только если они больше нигде не используются.

## Страница /admin/vlastnosti/[attributeId] — значения свойства

Что есть:
- Список значений (термы) по таксономии `pa_<attributeName>`.
- Создание нового значения.
- Удаление значения.

Создание:
- Добавляется запись в `WpTerm` и `WpTermTaxonomy`.

Удаление:
- Удаляется связь `WpTermRelationship` и запись `WpTermTaxonomy`.
- Если терм больше нигде не используется — удаляется из `WpTerm` и `WpTermMeta`.

## Страница /admin/kategorie — настройки категорий

Что есть:
- Список всех категорий с редактированием прямо в таблице.
- Создание новой категории.
- Удаление категории (только если нет товаров и подкатегорий).

Поля категории:
- `name`, `slug`, `image`, `description`, `sortOrder`, `isActive`.
- `parentId` для иерархии.
- Флаги видимости по аудитории: `showInB2b`, `showInB2c`.

Поведение:
- При обновлении/создании сбрасываются теги кэша `categories`.
- Удаление блокируется при наличии связей.

## Важные ограничения и заметки

- Новые строки `WpMatrixPrice` создаются только через «Vygenerovať ceny».
- Для сериализации используется простая реализация PHP serialize/unserialize
  (должна совпадать с тем, как работает `lib/wp-calculator.ts`).
- HTML для описания товара очищается на сервере, ссылки сохраняются только с `https://`.
- Медиафайлы для редактора сохраняются в `/public/uploads` через `/api/uploads`.

## Страница /admin/top-products — Top produkty pre online tlač

Управление блоком «Top produkty pre online tlač», который отображается на главных страницах B2B и B2C.

### Возможности
- Отдельная конфигурация для B2B и B2C режимов.
- Три режима выбора товаров:
  - **Рандомно из всех** — случайный выбор из всех активных товаров для выбранного режима.
  - **Рандомно из выбранных категорий** — случайный выбор из товаров указанных категорий.
  - **Ручной выбор** — конкретный список товаров с возможностью дополнения случайными.

### Режимы подробно

#### Рандомно из всех (RANDOM_ALL)
При каждой загрузке главной страницы выбираются 8 случайных товаров из всех активных товаров, доступных для текущего режима (B2B/B2C).

#### Рандомно из выбранных категорий (RANDOM_CATEGORIES)
- Можно выбрать несколько категорий через ComboboxMultiple.
- При загрузке главной страницы выбираются 8 случайных товаров только из выбранных категорий.
- Учитывается доступность для текущего режима (B2B/B2C).

#### Ручной выбор (MANUAL)
- Можно выбрать конкретные товары через ComboboxMultiple.
- Если выбрано меньше 8 товаров — оставшиеся места заполняются случайными товарами из доступных для режима.
- Порядок отображения: сначала выбранные вручную, затем случайные.

### Интерфейс
- Вкладки для переключения между B2B и B2C конфигурацией.
- RadioGroup для выбора режима.
- ComboboxMultiple для выбора категорий (режим RANDOM_CATEGORIES) или товаров (режим MANUAL).
- Кнопка сохранения конфигурации.
- Toast-уведомления об успехе/ошибке сохранения.

### Технические детали
- Данные хранятся в таблице `TopProducts` с полями:
  - `audience` (b2b/b2c) — уникальный ключ.
  - `mode` — режим выбора товаров.
  - `categoryIds` — массив ID категорий (для RANDOM_CATEGORIES).
  - `productIds` — массив ID товаров (для MANUAL).
- API endpoints:
  - `GET/POST /api/admin/top-products` — управление конфигурацией (требует админ-доступ).
  - `GET /api/top-products?audience=b2b&count=8` — публичный API для получения товаров.
- Компонент отображения: `components/home/top-products-client.tsx`.
- Включено на главных страницах B2B и B2C с заголовком «Top produkty pre online tlač» и описанием сервиса.

## Следующие логичные шаги

- Добавить создание/редактирование комбинаций цен вручную (не только генерация).
- Добавить возможность изменения порядка товаров в ручном режиме Top produkty.

## Страница /admin/settings — Настройки магазина

Страница общих настроек магазина с вкладками для разных групп параметров.

### Вкладка "PDF / Faktúry"

Настройки генерации PDF-счетов. Компонент: `components/admin/pdf-settings-form.tsx`.

**Секции формы:**
1. **Údaje o firme** — данные компании:
   - Názov firmy (название)
   - Adresa (адрес)
   - Mesto a PSČ (город и индекс)
   - IČO, DIČ, IČ DPH

2. **Bankové údaje** — банковские реквизиты:
   - Názov banky
   - BIC/SWIFT
   - Kód banky
   - IBAN

3. **Číslovanie faktúr** — нумерация:
   - Prefix čísla faktúry (префикс номера)
   - Ďalšie číslo faktúry (следующий номер)
   - Splatnosť faktúry (dni) — дни до оплаты

4. **Automatická generácia** — автогенерация:
   - Status pre automatickú generáciu — при каком статусе генерировать
   - Automaticky odoslať e-mailom — отправлять ли на email

5. **Vzhľad faktúry** — оформление:
   - URL loga
   - URL podpisu/pečiatky
   - Text päty faktúry

**API:**
- `GET /api/admin/settings/pdf` — получение настроек
- `PUT /api/admin/settings/pdf` — сохранение настроек

**Хранение:** `ShopSettings.pdfSettings` (JSON поле)

**Документация:** см. `docs/PDF_INVOICES.md`

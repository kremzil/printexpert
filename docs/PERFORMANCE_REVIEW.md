# Обзор производительности проекта (Next.js)

Дата: 2026-02-17

## Что проверено

- `npm run lint`
- `npm run build`
- Конфигурация Next.js и серверные/клиентские горячие точки.

## Главные выводы

### 1) Сборка тормозится на трассировке файлов в `public/products`

Во время `next build` Turbopack сообщает, что динамические паттерны в API-роуте импорта матчят десятки тысяч файлов в `public/products`, что бьёт по времени сборки и может вести к over-bundling.

Проверенное улучшение:
- Добавлено исключение `outputFileTracingExcludes` и для App Router пути `"/app/api/admin/products/import/route"` (раньше было только legacy-правило `"/api/admin/products/import"`).

Ожидаемый эффект:
- Меньше лишней трассировки при production build.
- Более предсказуемое время сборки в CI.

### 2) Есть прямые сигналы по LCP/изображениям

Линтер показывает предупреждения `@next/next/no-img-element` на странице продукта. Это потенциально ухудшает LCP и расход трафика.

Рекомендация:
- Перевести эти участки на `next/image` (с фиксированными `sizes`/`fill` и корректным `priority` только для LCP-элементов).

### 3) Клиентский JS стоит уменьшить точечно

В проекте много Client Components (`"use client"`), что увеличивает гидратацию и JS payload. Это не ошибка само по себе, но есть потенциал оптимизации:

Рекомендация:
- Для тяжёлых экранов (карточка товара, редактор дизайна, корзина) вынести неизменяемые блоки в Server Components.
- Для интерактивных блоков использовать динамический импорт с `ssr: false` только там, где это действительно нужно.

### 4) Стабильность build зависит от БД во время prerender

`next build` падает на prerender страниц при `ECONNREFUSED` от Prisma. Это означает жёсткую связку статической генерации с доступностью БД на этапе сборки.

Рекомендация:
- Для страниц, где данные не гарантированы в build-time, рассмотреть `dynamic = 'force-dynamic'` или graceful fallback.
- В CI явно поднимать БД перед build (либо исключить такие страницы из SSG).

## Приоритизация (быстрые шаги)

1. **Сразу**: закрыть предупреждения Turbopack по file tracing (частично сделано в этом PR).
2. **Сразу**: заменить `<img>` на `next/image` в `product-page-client.tsx`.
3. **Далее**: пройтись по большим Client Components и вернуть в server-first модель там, где нет интерактивности.
4. **Далее**: стабилизировать стратегию prerender/SSR для страниц, зависимых от Prisma.

## Что даст максимальный прирост

- Сокращение времени сборки CI (трассировка + зависимость от БД).
- Улучшение LCP на продуктовых страницах (изображения + меньше клиентского JS).
- Снижение TBT/INP на слабых устройствах за счёт меньшей гидратации.

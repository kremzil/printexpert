# ExecPlan 0.2.1 → 0.2.2 (S3 uploads + Notifications)
Дата: 2026-01-26  
Проект: Printexpert Next  
Версия плана: 0.2.2-A  
Цель: загрузка файлов к заказам через S3 (presigned) + права доступа + единый сервис уведомлений с идемпотентным логом.

---

## Purpose

- Добавить поток загрузки файлов к заказу через S3 (presigned PUT) с подтверждением (confirm) и безопасной раздачей (presigned GET).
- Добавить доменную модель `OrderAsset` для учета загрузок и статусов.
- Реализовать UI загрузки в аккаунте клиента и просмотр в админке заказа.
- Сделать `NotificationService` + `NotificationLog` (идемпотентно, без дублей на событие).

---

## Constraints

- Агент **НЕ запускает миграции** и не проверяет БД командами. Он:
  - вносит изменения в код/Prisma schema,
  - обновляет документацию “что запустить вручную”.
- Публичные URL файлов не храним; только `objectKey`, выдача — presigned links.
- Доступ к ассетам: только владелец заказа и ADMIN.
- Не добавлять лишних внешних библиотек. (AWS SDK допустим.)

---

## Scope

### In scope (0.2.1)
- Prisma: `OrderAsset` (+ enums) + индексы.
- S3 upload flow:
  - `POST /api/uploads/presign`
  - `POST /api/uploads/confirm`
  - `GET /api/orders/[orderId]/assets`
  - `GET /api/assets/[assetId]/download` (302 redirect to presigned GET)
- UI:
  - `/account/orders/[orderId]`: блок “Nahrať grafiku” + список файлов
  - `/admin/orders/[orderId]`: список ассетов (все файлы заказа)

### In scope (0.2.2)
- `NotificationService`:
  - `sendOrderCreated(orderId)`
  - `sendOrderStatusChanged(orderId, from, to)`
  - `sendArtworkUploaded(orderId, assetId)` (опционально)
- Prisma: `NotificationLog` + идемпотентность (без дублей).

### Non-goals
- Stripe / payments / webhook (это ExecPlan B).
- Audit trail статусов (это ExecPlan B).
- Матрицы цен, корзина, аккаунты, роли (кроме проверки ADMIN на ассеты).
- Сложные политики хранения (retention), антивирус, конвертация файлов.

---

## Milestones

### M1 — Prisma: OrderAsset (+ enums, indexes)

Добавить модель:

**OrderAsset**
- `id` (uuid/cuid — выбрать тот, что у вас принят для доменных сущностей)
- `orderId` FK
- `orderItemId` nullable FK
- `kind` enum: `ARTWORK | PREVIEW | INVOICE | OTHER`
- `status` enum: `PENDING | UPLOADED | APPROVED | REJECTED`
- `fileNameOriginal`
- `mimeType` (expected)
- `sizeBytes` (expected)
- `checksum?`
- `storageProvider` enum: `S3`
- `bucket`
- `objectKey`
- `region?`
- `uploadedByUserId?` FK
- `createdAt`, `updatedAt`

Индексы:
- `(orderId, createdAt)`
- `(orderItemId)`
- `(status)`

Notes:
- Не хранить постоянные публичные URL.
- `mimeType/sizeBytes` считаем “expected”; confirm сверяет фактический объект.

Acceptance:
- Prisma schema компилируется.
- Enum’ы названы последовательно с остальными в проекте.

---

### M2 — S3 strategy + helpers

Соглашение по ключам:
- `orders/{orderId}/{assetId}/{sanitizedFileName}`

Вспомогательные утилиты:
- sanitize/slugify имени файла (без пути, без спецсимволов)
- denylist расширений (например: exe, js, sh, bat, cmd, php, py, pl, etc.)
- allowlist MIME
- size limit (например `UPLOAD_MAX_BYTES=100_000_000`), вынести в конфиг

Acceptance:
- Ключи детерминированы и безопасны.
- Валидация типа/размера выполняется **до** выдачи presigned PUT.

---

### M3 — API: presign endpoint

`POST /api/uploads/presign`

Input:
- `orderId`
- `orderItemId?`
- `kind`
- `fileName`
- `mimeType`
- `sizeBytes`

Server behavior:
- Auth required.
- Permission:
  - owner of order OR ADMIN.
- Validate:
  - size <= limit
  - mime in allowlist
  - extension allowed
- Create `OrderAsset`:
  - status = `PENDING`
  - persist expected mime/size, bucket, region, objectKey
- Generate presigned PUT for `objectKey`
- Return:
  - `assetId`, `objectKey`, `uploadUrl`
  - (optional) required headers

Acceptance:
- Endpoint rejects invalid mime/size/extension.
- ObjectKey is server-generated (client cannot choose it).

---

### M4 — API: confirm endpoint (HEAD verify)

`POST /api/uploads/confirm`

Input:
- `assetId`

Server behavior:
- Auth required.
- Permission: owner OR ADMIN.
- Do HEAD in S3 for the objectKey.
- Verify:
  - content-length equals expected sizeBytes
  - content-type matches expected mimeType when feasible (handle mismatches carefully)
- If mismatch:
  - Either set status `REJECTED` with note, or return 400 and keep PENDING.
- If OK:
  - set status `UPLOADED`

Acceptance:
- Confirm does not mark uploaded if object missing.
- Confirm prevents accepting mismatched size.

---

### M5 — API: list assets + download (presigned GET + redirect)

1) `GET /api/orders/[orderId]/assets`
- Auth required
- Permission: owner OR ADMIN
- Return list of assets (no URL)

2) `GET /api/assets/[assetId]/download`
- Auth required
- Permission: owner OR ADMIN
- Generate presigned GET
- Respond:
  - **302 redirect** to presigned URL (preferred)
  - (or JSON with url if needed; choose one and record decision)

Acceptance:
- Non-owner/non-admin cannot list or download.
- Browser downloads work without server streaming.

---

### M6 — UI: client account order details

Page: `/account/orders/[orderId]`

Add block:
- Title: “Nahrať grafiku”
- Show:
  - allowed formats
  - size limit
- Upload flow:
  - choose file
  - call presign
  - PUT to S3
  - call confirm
- List existing assets:
  - name, kind, status, size
  - download button (calls download endpoint)

Acceptance:
- Upload works end-to-end.
- List updates after confirm (refresh UI or re-fetch).

---

### M7 — UI: admin order details

Page: `/admin/orders/[orderId]`

Add block:
- list all assets for the order with statuses
- download actions

Acceptance:
- Admin sees any order assets.
- UI stays consistent with admin design.

---

### M8 — Notifications: NotificationLog + NotificationService

**NotificationLog**
- `id`
- `type` enum
- `orderId?`
- `toEmail`
- `status` enum `SENT|FAILED`
- `error?`
- `providerMessageId?`
- `createdAt`

Idempotency:
- unique key `(type, orderId, toEmail)` so one email per event

**NotificationService**
- Centralize email sending; do not scatter SMTP calls.
- Each send method:
  - tries to create log row first (or upsert), then sends
  - on success: mark SENT + providerMessageId
  - on failure: mark FAILED + error

Methods:
- `sendOrderCreated(orderId)`
- `sendOrderStatusChanged(orderId, from, to)`
- `sendArtworkUploaded(orderId, assetId)` (optional)

Acceptance:
- No duplicate sends for the same `(type, orderId, toEmail)`.
- Failures are logged.

---

## Validation and Acceptance (manual verification)

### Uploads (S3)
- [ ] клиент может загрузить файл к заказу через presigned URL
- [ ] файл отображается в деталях заказа в аккаунте и в админке
- [ ] доступ к скачиванию только у владельца и ADMIN (через presigned GET + redirect)
- [ ] записи OrderAsset создаются и меняют статус PENDING→UPLOADED
- [ ] лимиты типа/размера работают
- [ ] confirm сверяет HEAD и не принимает mismatch

### Emails
- [ ] письмо “order created” уходит клиенту и (опц) менеджеру
- [ ] письмо “status changed” уходит клиенту
- [ ] (опц) “artwork uploaded” уходит менеджеру/клиенту
- [ ] есть NotificationLog, нет дубликатов на одно событие

---

## Env checklist

S3:
- `S3_BUCKET`
- `S3_REGION`
- `S3_ACCESS_KEY_ID`
- `S3_SECRET_ACCESS_KEY`
- `S3_ENDPOINT` (если S3-compatible)
- `UPLOAD_MAX_BYTES` (recommended)

Auth/Roles:
- `NEXTAUTH_SECRET`

SMTP env already exists.

---

## Manual steps (you run these)

After code/schema changes:
- Apply Prisma migrations:
  - `npx prisma migrate dev` (dev)
  - `npx prisma migrate deploy` (prod)

S3 setup:
- Create bucket and IAM user/role with least privilege for:
  - `s3:PutObject`, `s3:GetObject`, `s3:HeadObject` on prefix `orders/*`
- If S3-compatible:
  - set endpoint and required addressing mode (document if needed)

---

## Progress (keep updated with timestamps)

- [x] (2026-01-26 19:31) M1 Prisma: OrderAsset model + enums + indexes
- [x] (2026-01-26 19:31) M2 S3 helpers: keying + validation (mime/size/ext)
- [x] (2026-01-26 19:31) M3 API: /api/uploads/presign
- [x] (2026-01-26 19:31) M4 API: /api/uploads/confirm (HEAD verify)
- [x] (2026-01-26 19:31) M5 API: list assets + download redirect
- [x] (2026-01-26 19:31) M6 UI: account order upload + list + download
- [x] (2026-01-26 19:31) M7 UI: admin order assets + download
- [x] (2026-01-26 19:31) M8 Notifications: NotificationLog + NotificationService idempotency
- [ ] (YYYY-MM-DD HH:MM) Final: acceptance checklist reviewed + summary notes

---

## Decision Log (append entries)

- (2026-01-26) Upload pattern: presigned PUT + confirm (HEAD verify).
- (2026-01-26) Download response: 302 redirect to presigned GET (browser-friendly).
- (2026-01-26) Rejection behavior on confirm mismatch: set status REJECTED (neprijímame nezhody veľkosti/MIME).
- (2026-01-26) Upload max size: 100_000_000 bytes (100 MB) default, override via UPLOAD_MAX_BYTES.
- (2026-01-26) MIME allowlist: application/pdf, application/postscript, application/illustrator, application/vnd.adobe.illustrator, image/jpeg, image/png, image/tiff, image/webp, image/svg+xml.

---

## Surprises & Discoveries (append entries)

- (YYYY-MM-DD) Existing Order model lacks fields required for permission check; adjusted.
- (YYYY-MM-DD) S3-compatible endpoint requires special config; documented.
- (YYYY-MM-DD) Admin role detection differs from expected; updated access checks accordingly.

---

## Outcomes & Retrospective (fill at end)

- What shipped:
- What was deferred:
- Follow-ups:
